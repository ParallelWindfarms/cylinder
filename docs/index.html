<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Johan Hidding and Pablo Rodríguez" />
  <title>Flow past a cylinder and Parareal</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!-- Bootstrap 4.5.0 stylesheet -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <link rel="stylesheet" href="css/mods.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<!-- <script data-main="scripts/main" src="js/require.js"></script> -->
  <!-- Load React. -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
<!--  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script> -->


</head>
<body class="d-flex flex-column">

<nav id="TOC" class="navbar navbar-dark bg-dark">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a href="#" class="ml-5 mr-auto navbar-brand">Flow past a cylinder and Parareal<br><span style="font-size: smaller"> 
        by <i>Johan Hidding and Pablo Rodríguez</i></span></a>
<div class="collapse navbar-collapse" id="navbarSupportedContent">
<ul>
<li><a href="#problem">Problem</a></li>
<li><a href="#pyfoam">PyFOAM</a></li>
<li><a href="#interface-with-paranoodles">Interface with ParaNoodles</a></li>
<li><a href="#running-parareal">Running Parareal</a></li>
<li><a href="#the-user-script">The User script</a></li>
<li><a href="#appendix-a-utils">Appendix A: Utils</a></li>
<li><a href="#input-and-output">Input and Output</a></li>
</ul>
</div>
</nav>

<!-- <nav class="navbar navbar-dark navbar-expand-md bg-dark mb-4">
<p class="author">Johan Hidding and Pablo Rodríguez</p>
</nav>
 -->

<main role="main" class="flex-fill"><div class="container my-5">
<p>Aim: simulate the turbulent flow past a cylinder in OpenFOAM and parallelise with Parareal.</p>
<p>Steps:</p>
<ol type="1">
<li>Follow the <a href="https://wiki.openfoam.com/Vortex_shedding_by_Joel_Guerrero_2D">tutorial</a> at <a href="http://www.wolfdynamics.com/wiki/T5_2D_cylinder.pdf">Wolf Dynamics</a>, supplementary material: <a href="http://www.wolfdynamics.com/wiki/vortex_shedding.tar.gz">vortex_shedding.tar.gz</a>.</li>
<li>Run tutorial straight from Python using pyFOAM.</li>
<li>Run parallel-in-time using Parareal in Python with Noodles.</li>
</ol>
<h1 id="problem">Problem</h1>
<figure>
<img src="./img/case-result.png" alt="Flow around cylinder with Reynold’s number 200." /><figcaption aria-hidden="true">Flow around cylinder with Reynold’s number 200.</figcaption>
</figure>
<p>To install the requirements, also clone <a href="https://github.com/ParallelWindfarms/paranoodles">ParaNoodles</a> and run <code>pip install .</code> from its project root. To install additional requirements, have OpenFOAM installed and:</p>
<pre class="shell"><code>pip install -r requirements.txt</code></pre>
<h1 id="pyfoam">PyFOAM</h1>
<p>PyFOAM is not so well documented. For our application we’d like to do two things: modify the run-directory and run <code>icoFoam</code>. We’ll start with the following modules:</p>
<ul>
<li><code>PyFoam.Execution</code></li>
<li><code>PyFoam.RunDictionary</code></li>
<li><code>PyFoam.LogAnalysis</code></li>
</ul>
<p>The PyFAOM module comes with a lot of tools to analyse the logs that are being created so fanatically by the solvers.</p>
<h2 id="running-elbow-example">Running <code>elbow</code> example</h2>
<p>To run the “elbow” example:</p>
<div class="annotated-code">
<p><span><em>«elbow-example»=</em></span></p>
<div class="sourceCode" id="elbow-example"><pre class="sourceCode python"><code class="sourceCode python"><span id="elbow-example-1"><a href="#elbow-example-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyFoam.Execution.AnalyzedRunner <span class="im">import</span> AnalyzedRunner</span>
<span id="elbow-example-2"><a href="#elbow-example-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyFoam.LogAnalysis.StandardLogAnalyzer <span class="im">import</span> StandardLogAnalyzer</span></code></pre></div>
</div>
<p>The <code>AnalyzedRunner</code> runs a command and sends the results to an <code>Analyzer</code> object, all found in the <code>PyFoam.LogAnalysis</code> module, in this case the <code>StandardLogAnalyzer</code>.</p>
<div class="sourceCode" id="cb2" data-session="0"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pintFoam.utils <span class="im">import</span> pushd</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">&quot;./elbow&quot;</span>).absolute()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>solver <span class="op">=</span> <span class="st">&quot;icoFoam&quot;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pushd(path):</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    run <span class="op">=</span> AnalyzedRunner(StandardLogAnalyzer(), argv<span class="op">=</span>[solver], silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    run.start()</span></code></pre></div>
<h3 id="get-results">Get results</h3>
<p>All access to files goes through the <code>PyFoam.RunDictionary</code> submodule.</p>
<div class="sourceCode" id="cb3" data-session="0"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyFoam.RunDictionary.SolutionDirectory <span class="im">import</span> SolutionDirectory</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>dire <span class="op">=</span> SolutionDirectory(path)</span></code></pre></div>
<p>Query for the time slices,</p>
<div class="sourceCode" id="cb4" data-session="0"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dire.times</span></code></pre></div>
<p>And read some result data,</p>
<div class="sourceCode" id="cb5" data-session="0" data-clip-output="4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> dire[<span class="dv">10</span>][<span class="st">&#39;p&#39;</span>].getContent()[<span class="st">&#39;internalField&#39;</span>]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>np.array(p.val)</span></code></pre></div>
<h3 id="clear-results">Clear results</h3>
<div class="sourceCode" id="cb6" data-session="0"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dire.clearResults()</span></code></pre></div>
<h3 id="change-integration-interval-and-time-step">Change integration interval and time step</h3>
<p>We’ll now access the <code>controlDict</code> file.</p>
<div class="sourceCode" id="cb7" data-session="0"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyFoam.RunDictionary.ParsedParameterFile <span class="im">import</span> ParsedParameterFile</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>controlDict <span class="op">=</span> ParsedParameterFile(dire.controlDict())</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>controlDict.content</span></code></pre></div>
<p>change the end time</p>
<div class="sourceCode" id="cb8" data-session="0"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>controlDict[<span class="st">&#39;endTime&#39;</span>] <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>controlDict.writeFile()</span></code></pre></div>
<h1 id="interface-with-paranoodles">Interface with ParaNoodles</h1>
<p>We need to define the following:</p>
<ul>
<li><code>Vector</code></li>
<li>fine <code>Solution</code></li>
<li>coarse <code>Solution</code></li>
<li>coarsening operator</li>
<li>refinement operator (interpolation)</li>
</ul>
<p>The last two steps will require the use of the <code>mapFields</code> utility in OpenFOAM and may require some tweaking to work out.</p>
<ul class="task-list">
<li><input type="checkbox" disabled="" />
figure out how to work <code>mapFields</code>, and make this scriptable from Python.</li>
</ul>
<h2 id="vector">Vector</h2>
<p>The abstract <code>Vector</code>, defined below, represents any single state in the simulation. It consists of a <code>RunDirectory</code> and a time-frame.</p>
<div class="annotated-code">
<p><span><em>«pintFoam/vector.py»=</em></span></p>
<div class="sourceCode" id="cb9" data-file="pintFoam/vector.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> operator</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mmap</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> contextlib <span class="im">import</span> contextmanager</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> uuid <span class="im">import</span> uuid4</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shutil <span class="im">import</span> copytree, rmtree   <span class="co"># , copy</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Optional</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> byteparsing <span class="im">import</span> parse_bytes, foam_file</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># from .utils import pushd</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyFoam.RunDictionary.ParsedParameterFile <span class="im">import</span> ParsedParameterFile  <span class="co"># type: ignore</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyFoam.RunDictionary.SolutionDirectory <span class="im">import</span> SolutionDirectory      <span class="co"># type: ignore</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>base<span class="op">-</span>case<span class="op">&gt;&gt;</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span>vector<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h3 id="base-case">Base case</h3>
<p>We will operate on a <code>Vector</code> the same way everything is done in OpenFOAM, that is:</p>
<ol type="1">
<li>Copy-paste a case (known as the base case)</li>
<li>Edit the copy with new simulation parameters</li>
<li>Run the simulation</li>
</ol>
<p>This is why for every <code>Vector</code> we define a <code>BaseCase</code> that is used to generate new vectors. The <code>BaseCase</code> should have only one time directory containing the initial conditions, namely <code>0</code>. The simulation generates new folders containing the data corresponding to different times. The time is coded, somewhat uncomfortably, in the directory name (<code>0.01</code>, <code>0.02</code>, and so on).</p>
<p>The class <code>Vector</code> takes care of all those details.</p>
<div class="annotated-code">
<p><span><em>«base-case»=</em></span></p>
<div class="sourceCode" id="base-case"><pre class="sourceCode python"><code class="sourceCode python"><span id="base-case-1"><a href="#base-case-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="base-case-2"><a href="#base-case-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BaseCase:</span>
<span id="base-case-3"><a href="#base-case-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Base case is a cleaned version of the system. If it contains any fields,</span></span>
<span id="base-case-4"><a href="#base-case-4" aria-hidden="true" tabindex="-1"></a><span class="co">    it will only be the `0` time. Any field that is copied for manipulation will</span></span>
<span id="base-case-5"><a href="#base-case-5" aria-hidden="true" tabindex="-1"></a><span class="co">    do so on top of an available base case in the `0` slot.&quot;&quot;&quot;</span></span>
<span id="base-case-6"><a href="#base-case-6" aria-hidden="true" tabindex="-1"></a>    root: Path</span>
<span id="base-case-7"><a href="#base-case-7" aria-hidden="true" tabindex="-1"></a>    case: <span class="bu">str</span></span>
<span id="base-case-8"><a href="#base-case-8" aria-hidden="true" tabindex="-1"></a>    fields: Optional[List[<span class="bu">str</span>]] <span class="op">=</span> <span class="va">None</span></span>
<span id="base-case-9"><a href="#base-case-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="base-case-10"><a href="#base-case-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="base-case-11"><a href="#base-case-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> path(<span class="va">self</span>):</span>
<span id="base-case-12"><a href="#base-case-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.root <span class="op">/</span> <span class="va">self</span>.case</span>
<span id="base-case-13"><a href="#base-case-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="base-case-14"><a href="#base-case-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> new_vector(<span class="va">self</span>, name: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="base-case-15"><a href="#base-case-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Creates new `Vector` using this base case.&quot;&quot;&quot;</span></span>
<span id="base-case-16"><a href="#base-case-16" aria-hidden="true" tabindex="-1"></a>        new_case <span class="op">=</span> name <span class="kw">or</span> uuid4().<span class="bu">hex</span></span>
<span id="base-case-17"><a href="#base-case-17" aria-hidden="true" tabindex="-1"></a>        new_path <span class="op">=</span> <span class="va">self</span>.root <span class="op">/</span> new_case</span>
<span id="base-case-18"><a href="#base-case-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> new_path.exists():</span>
<span id="base-case-19"><a href="#base-case-19" aria-hidden="true" tabindex="-1"></a>            copytree(<span class="va">self</span>.path, new_path)</span>
<span id="base-case-20"><a href="#base-case-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Vector(<span class="va">self</span>, new_case, <span class="st">&quot;0&quot;</span>)</span>
<span id="base-case-21"><a href="#base-case-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="base-case-22"><a href="#base-case-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> all_vector_paths(<span class="va">self</span>):</span>
<span id="base-case-23"><a href="#base-case-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Iterates all sub-directories in the root.&quot;&quot;&quot;</span></span>
<span id="base-case-24"><a href="#base-case-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (x <span class="cf">for</span> x <span class="kw">in</span> <span class="va">self</span>.root.iterdir()</span>
<span id="base-case-25"><a href="#base-case-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> x.is_dir() <span class="kw">and</span> x.name <span class="op">!=</span> <span class="va">self</span>.case)</span>
<span id="base-case-26"><a href="#base-case-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="base-case-27"><a href="#base-case-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> clean(<span class="va">self</span>):</span>
<span id="base-case-28"><a href="#base-case-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Deletes all vectors of this base-case.&quot;&quot;&quot;</span></span>
<span id="base-case-29"><a href="#base-case-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> path <span class="kw">in</span> <span class="va">self</span>.all_vector_paths():</span>
<span id="base-case-30"><a href="#base-case-30" aria-hidden="true" tabindex="-1"></a>            rmtree(path)</span></code></pre></div>
</div>
<p>In our implementation, if no name is given to a new vector, a random one is generated.</p>
<h3 id="retrieving-files-and-time-directories">Retrieving files and time directories</h3>
<p>Note that the <code>BaseCase</code> has a property <code>path</code>. The same property will be defined in <code>Vector</code>. We can use this common property to retrieve a <code>SolutionDirectory</code>, <code>ParameterFile</code> or <code>TimeDirectory</code>.</p>
<ul class="task-list">
<li><input type="checkbox" disabled="" />
These are PyFoam routines that may need to be replaced</li>
</ul>
<div class="annotated-code">
<p><span><em>«pintfoam-vector»=</em></span></p>
<div class="sourceCode" id="pintfoam-vector"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-vector-1"><a href="#pintfoam-vector-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> solution_directory(case):</span>
<span id="pintfoam-vector-2"><a href="#pintfoam-vector-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> SolutionDirectory(case.path)</span>
<span id="pintfoam-vector-3"><a href="#pintfoam-vector-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-4"><a href="#pintfoam-vector-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parameter_file(case, relative_path):</span>
<span id="pintfoam-vector-5"><a href="#pintfoam-vector-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ParsedParameterFile(case.path <span class="op">/</span> relative_path)</span>
<span id="pintfoam-vector-6"><a href="#pintfoam-vector-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-7"><a href="#pintfoam-vector-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> time_directory(case):</span>
<span id="pintfoam-vector-8"><a href="#pintfoam-vector-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> solution_directory(case)[case.time]</span>
<span id="pintfoam-vector-9"><a href="#pintfoam-vector-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-10"><a href="#pintfoam-vector-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-11"><a href="#pintfoam-vector-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_times(path):</span>
<span id="pintfoam-vector-12"><a href="#pintfoam-vector-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Get all the snapshots in a case, sorted on floating point value.&quot;&quot;&quot;</span></span>
<span id="pintfoam-vector-13"><a href="#pintfoam-vector-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> isfloat(s: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="pintfoam-vector-14"><a href="#pintfoam-vector-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="pintfoam-vector-15"><a href="#pintfoam-vector-15" aria-hidden="true" tabindex="-1"></a>            <span class="bu">float</span>(s)</span>
<span id="pintfoam-vector-16"><a href="#pintfoam-vector-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="pintfoam-vector-17"><a href="#pintfoam-vector-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="pintfoam-vector-18"><a href="#pintfoam-vector-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="pintfoam-vector-19"><a href="#pintfoam-vector-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-20"><a href="#pintfoam-vector-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(</span>
<span id="pintfoam-vector-21"><a href="#pintfoam-vector-21" aria-hidden="true" tabindex="-1"></a>        [s.name <span class="cf">for</span> s <span class="kw">in</span> path.iterdir() <span class="cf">if</span> isfloat(s.name)],</span>
<span id="pintfoam-vector-22"><a href="#pintfoam-vector-22" aria-hidden="true" tabindex="-1"></a>        key<span class="op">=</span><span class="bu">float</span>)</span></code></pre></div>
</div>
<h3 id="vector-1">Vector</h3>
<div class="annotated-code">
<p><span><em>«pintfoam-vector»+</em></span></p>
<div class="sourceCode" id="pintfoam-vector"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-vector-1"><a href="#pintfoam-vector-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="pintfoam-vector-2"><a href="#pintfoam-vector-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Vector:</span>
<span id="pintfoam-vector-3"><a href="#pintfoam-vector-3" aria-hidden="true" tabindex="-1"></a>    base: BaseCase</span>
<span id="pintfoam-vector-4"><a href="#pintfoam-vector-4" aria-hidden="true" tabindex="-1"></a>    case: <span class="bu">str</span></span>
<span id="pintfoam-vector-5"><a href="#pintfoam-vector-5" aria-hidden="true" tabindex="-1"></a>    time: <span class="bu">str</span></span>
<span id="pintfoam-vector-6"><a href="#pintfoam-vector-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-7"><a href="#pintfoam-vector-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span>vector<span class="op">-</span>properties<span class="op">&gt;&gt;</span></span>
<span id="pintfoam-vector-8"><a href="#pintfoam-vector-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span>vector<span class="op">-</span>clone<span class="op">&gt;&gt;</span></span>
<span id="pintfoam-vector-9"><a href="#pintfoam-vector-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span>vector<span class="op">-</span>operate<span class="op">&gt;&gt;</span></span>
<span id="pintfoam-vector-10"><a href="#pintfoam-vector-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span>vector<span class="op">-</span>operators<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>From a vector we can extract a file path pointing to the specified time slot, list the containing files and read out <code>internalField</code> from any of those files.</p>
<div class="annotated-code">
<p><span><em>«pintfoam-vector-properties»=</em></span></p>
<div class="sourceCode" id="pintfoam-vector-properties"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-vector-properties-1"><a href="#pintfoam-vector-properties-1" aria-hidden="true" tabindex="-1"></a><span class="at">@property</span></span>
<span id="pintfoam-vector-properties-2"><a href="#pintfoam-vector-properties-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> path(<span class="va">self</span>):</span>
<span id="pintfoam-vector-properties-3"><a href="#pintfoam-vector-properties-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Case path, i.e. the path containing `system`, `constant` and snapshots.&quot;&quot;&quot;</span></span>
<span id="pintfoam-vector-properties-4"><a href="#pintfoam-vector-properties-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.base.root <span class="op">/</span> <span class="va">self</span>.case</span>
<span id="pintfoam-vector-properties-5"><a href="#pintfoam-vector-properties-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-properties-6"><a href="#pintfoam-vector-properties-6" aria-hidden="true" tabindex="-1"></a><span class="at">@property</span></span>
<span id="pintfoam-vector-properties-7"><a href="#pintfoam-vector-properties-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fields(<span class="va">self</span>):</span>
<span id="pintfoam-vector-properties-8"><a href="#pintfoam-vector-properties-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;All fields relevant to this base case.&quot;&quot;&quot;</span></span>
<span id="pintfoam-vector-properties-9"><a href="#pintfoam-vector-properties-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.base.fields</span>
<span id="pintfoam-vector-properties-10"><a href="#pintfoam-vector-properties-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-properties-11"><a href="#pintfoam-vector-properties-11" aria-hidden="true" tabindex="-1"></a><span class="at">@property</span></span>
<span id="pintfoam-vector-properties-12"><a href="#pintfoam-vector-properties-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dirname(<span class="va">self</span>):</span>
<span id="pintfoam-vector-properties-13"><a href="#pintfoam-vector-properties-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;The path of this snapshot.&quot;&quot;&quot;</span></span>
<span id="pintfoam-vector-properties-14"><a href="#pintfoam-vector-properties-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.path <span class="op">/</span> <span class="va">self</span>.time</span>
<span id="pintfoam-vector-properties-15"><a href="#pintfoam-vector-properties-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-properties-16"><a href="#pintfoam-vector-properties-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_times(<span class="va">self</span>):</span>
<span id="pintfoam-vector-properties-17"><a href="#pintfoam-vector-properties-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Get all available times, in order.&quot;&quot;&quot;</span></span>
<span id="pintfoam-vector-properties-18"><a href="#pintfoam-vector-properties-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [Vector(<span class="va">self</span>.base, <span class="va">self</span>.case, t)</span>
<span id="pintfoam-vector-properties-19"><a href="#pintfoam-vector-properties-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> get_times(<span class="va">self</span>.path)]</span>
<span id="pintfoam-vector-properties-20"><a href="#pintfoam-vector-properties-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-properties-21"><a href="#pintfoam-vector-properties-21" aria-hidden="true" tabindex="-1"></a><span class="at">@contextmanager</span></span>
<span id="pintfoam-vector-properties-22"><a href="#pintfoam-vector-properties-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mmap_data(<span class="va">self</span>, field):</span>
<span id="pintfoam-vector-properties-23"><a href="#pintfoam-vector-properties-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Context manager that yields a **mutable** reference to the data contained</span></span>
<span id="pintfoam-vector-properties-24"><a href="#pintfoam-vector-properties-24" aria-hidden="true" tabindex="-1"></a><span class="co">    in this snapshot. Mutations done to this array are mmapped to the disk directly.&quot;&quot;&quot;</span></span>
<span id="pintfoam-vector-properties-25"><a href="#pintfoam-vector-properties-25" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> (<span class="va">self</span>.dirname <span class="op">/</span> field).<span class="bu">open</span>(mode<span class="op">=</span><span class="st">&quot;r+b&quot;</span>)</span>
<span id="pintfoam-vector-properties-26"><a href="#pintfoam-vector-properties-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mmap.mmap(f.fileno(), <span class="dv">0</span>) <span class="im">as</span> mm:</span>
<span id="pintfoam-vector-properties-27"><a href="#pintfoam-vector-properties-27" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> parse_bytes(foam_file, mm)</span>
<span id="pintfoam-vector-properties-28"><a href="#pintfoam-vector-properties-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="pintfoam-vector-properties-29"><a href="#pintfoam-vector-properties-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> content[<span class="st">&quot;data&quot;</span>][<span class="st">&quot;internalField&quot;</span>]</span>
<span id="pintfoam-vector-properties-30"><a href="#pintfoam-vector-properties-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">KeyError</span> <span class="im">as</span> e:</span>
<span id="pintfoam-vector-properties-31"><a href="#pintfoam-vector-properties-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(content)</span>
<span id="pintfoam-vector-properties-32"><a href="#pintfoam-vector-properties-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> e</span></code></pre></div>
</div>
<p>We clone a vector by creating a new vector and copying the internal fields.</p>
<div class="annotated-code">
<p><span><em>«pintfoam-vector-clone»=</em></span></p>
<div class="sourceCode" id="pintfoam-vector-clone"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-vector-clone-1"><a href="#pintfoam-vector-clone-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clone(<span class="va">self</span>, name: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> Vector:</span>
<span id="pintfoam-vector-clone-2"><a href="#pintfoam-vector-clone-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Clone this vector to a new one. The clone only contains this single snapshot.&quot;&quot;&quot;</span></span>
<span id="pintfoam-vector-clone-3"><a href="#pintfoam-vector-clone-3" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.base.new_vector(name)</span>
<span id="pintfoam-vector-clone-4"><a href="#pintfoam-vector-clone-4" aria-hidden="true" tabindex="-1"></a>    x.time <span class="op">=</span> <span class="va">self</span>.time</span>
<span id="pintfoam-vector-clone-5"><a href="#pintfoam-vector-clone-5" aria-hidden="true" tabindex="-1"></a>    rmtree(x.dirname, ignore_errors<span class="op">=</span><span class="va">True</span>)</span>
<span id="pintfoam-vector-clone-6"><a href="#pintfoam-vector-clone-6" aria-hidden="true" tabindex="-1"></a>    copytree(<span class="va">self</span>.dirname, x.dirname)</span>
<span id="pintfoam-vector-clone-7"><a href="#pintfoam-vector-clone-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span></code></pre></div>
</div>
<p>In order to apply the parareal algorithm to our vectors (or indeed, any other algorithm worth that name), we need to define how to operate with them. Particularly, we’ll need to implement:</p>
<ul>
<li>Vector addition and subtraction (as we’ll need to sum and subtract the results of applying the coarse and fine integrators)</li>
<li>Vector scaling (as the integrators involve scaling with the inverse of the step)</li>
</ul>
<p>In order to achieve this, first we’ll write generic recipes for <strong>any</strong> operation between vectors and <strong>any</strong> operation between a scalar and a vector:</p>
<div class="annotated-code">
<p><span><em>«pintfoam-vector-operate»=</em></span></p>
<div class="sourceCode" id="pintfoam-vector-operate"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-vector-operate-1"><a href="#pintfoam-vector-operate-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> zip_with(<span class="va">self</span>, other: Vector, op) <span class="op">-&gt;</span> Vector:</span>
<span id="pintfoam-vector-operate-2"><a href="#pintfoam-vector-operate-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.clone()</span>
<span id="pintfoam-vector-operate-3"><a href="#pintfoam-vector-operate-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-operate-4"><a href="#pintfoam-vector-operate-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> <span class="va">self</span>.fields:</span>
<span id="pintfoam-vector-operate-5"><a href="#pintfoam-vector-operate-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> x.mmap_data(f) <span class="im">as</span> a, other.mmap_data(f) <span class="im">as</span> b:</span>
<span id="pintfoam-vector-operate-6"><a href="#pintfoam-vector-operate-6" aria-hidden="true" tabindex="-1"></a>            a[:] <span class="op">=</span> op(a, b)</span>
<span id="pintfoam-vector-operate-7"><a href="#pintfoam-vector-operate-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="pintfoam-vector-operate-8"><a href="#pintfoam-vector-operate-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-operate-9"><a href="#pintfoam-vector-operate-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="bu">map</span>(<span class="va">self</span>, f) <span class="op">-&gt;</span> Vector:</span>
<span id="pintfoam-vector-operate-10"><a href="#pintfoam-vector-operate-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.clone()</span>
<span id="pintfoam-vector-operate-11"><a href="#pintfoam-vector-operate-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-operate-12"><a href="#pintfoam-vector-operate-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> <span class="va">self</span>.fields:</span>
<span id="pintfoam-vector-operate-13"><a href="#pintfoam-vector-operate-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> x.mmap_data(f) <span class="im">as</span> a:</span>
<span id="pintfoam-vector-operate-14"><a href="#pintfoam-vector-operate-14" aria-hidden="true" tabindex="-1"></a>            a[:] <span class="op">=</span> f(a)</span>
<span id="pintfoam-vector-operate-15"><a href="#pintfoam-vector-operate-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span></code></pre></div>
</div>
<p>We now have the tools to define vector addition, subtraction and scaling.</p>
<div class="annotated-code">
<p><span><em>«pintfoam-vector-operators»=</em></span></p>
<div class="sourceCode" id="pintfoam-vector-operators"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-vector-operators-1"><a href="#pintfoam-vector-operators-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__sub__</span>(<span class="va">self</span>, other: Vector) <span class="op">-&gt;</span> Vector:</span>
<span id="pintfoam-vector-operators-2"><a href="#pintfoam-vector-operators-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.zip_with(other, operator.sub)</span>
<span id="pintfoam-vector-operators-3"><a href="#pintfoam-vector-operators-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-operators-4"><a href="#pintfoam-vector-operators-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>, other: Vector) <span class="op">-&gt;</span> Vector:</span>
<span id="pintfoam-vector-operators-5"><a href="#pintfoam-vector-operators-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.zip_with(other, operator.add)</span>
<span id="pintfoam-vector-operators-6"><a href="#pintfoam-vector-operators-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-vector-operators-7"><a href="#pintfoam-vector-operators-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__mul__</span>(<span class="va">self</span>, scale: <span class="bu">float</span>) <span class="op">-&gt;</span> Vector:</span>
<span id="pintfoam-vector-operators-8"><a href="#pintfoam-vector-operators-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.<span class="bu">map</span>(<span class="kw">lambda</span> x: x <span class="op">*</span> scale)</span></code></pre></div>
</div>
<p>In the code chunk above we used the so-called magic methods. If we use a minus sign to subtract two vectors, the method <code>__sub__</code> is being executed under the hood.</p>
<h3 id="setfields-utility"><code>setFields</code> utility</h3>
<p>We may want to call <code>setFields</code> on our <code>Vector</code> to setup some test cases.</p>
<ul class="task-list">
<li><input type="checkbox" disabled="" />
add doc-string</li>
</ul>
<div class="annotated-code">
<p><span><em>«pintfoam-set-fields»=</em></span></p>
<div class="sourceCode" id="pintfoam-set-fields"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-set-fields-1"><a href="#pintfoam-set-fields-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_fields(v, <span class="op">*</span>, defaultFieldValues, regions):</span>
<span id="pintfoam-set-fields-2"><a href="#pintfoam-set-fields-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> parameter_file(v, <span class="st">&quot;system/setFieldsDict&quot;</span>)</span>
<span id="pintfoam-set-fields-3"><a href="#pintfoam-set-fields-3" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&#39;defaultFieldValues&#39;</span>] <span class="op">=</span> defaultFieldValues</span>
<span id="pintfoam-set-fields-4"><a href="#pintfoam-set-fields-4" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&#39;regions&#39;</span>] <span class="op">=</span> regions</span>
<span id="pintfoam-set-fields-5"><a href="#pintfoam-set-fields-5" aria-hidden="true" tabindex="-1"></a>    x.writeFile()</span>
<span id="pintfoam-set-fields-6"><a href="#pintfoam-set-fields-6" aria-hidden="true" tabindex="-1"></a>    subprocess.run(<span class="st">&quot;setFields&quot;</span>, cwd<span class="op">=</span>v.path, check<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<h2 id="mesh-refinement">Mesh refinement</h2>
<div class="annotated-code">
<p><span><em>«pintFoam/foamTools.py»=</em></span></p>
<div class="sourceCode" id="cb10" data-file="pintFoam/foamTools.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .utils <span class="im">import</span> decorator</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>Stub <span class="op">=</span> Callable[[], <span class="va">None</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="at">@decorator</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Tool:</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    _func: Stub</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    command: <span class="bu">str</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    arguments: <span class="bu">list</span>[<span class="bu">str</span>]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
</div>
<h2 id="solution">Solution</h2>
<p>Remember, the definition of a <code>Solution</code>,</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>Solution <span class="op">=</span> Callable[[Vector, <span class="bu">float</span>, <span class="bu">float</span>], Vector]</span></code></pre></div>
<p>meaning, we write a function taking a current state <code>Vector</code>, the time <em>now</em>, and the <em>target</em> time, returning a new <code>Vector</code>.</p>
<div class="annotated-code">
<p><span><em>«pintFoam/solution.py»=</em></span></p>
<div class="sourceCode" id="cb12" data-file="pintFoam/solution.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Union</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .vector <span class="im">import</span> (BaseCase, Vector, parameter_file, get_times)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> block_mesh(case: BaseCase):</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    subprocess.run(<span class="st">&quot;blockMesh&quot;</span>, cwd<span class="op">=</span>case.path, check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span><span class="bu">set</span><span class="op">-</span>fields<span class="op">&gt;&gt;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span>epsilon<span class="op">&gt;&gt;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span>solution<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>The solver will write directories with floating-point valued names. This is a very bad idea by the folks at OpenFOAM, but it is one we’ll have to live with. Suppose you have a time-step of <span class="math inline">\(0.1\)</span>, what will be the names of the directories if you integrate from <span class="math inline">\(0\)</span> to <span class="math inline">\(0.5\)</span>?</p>
<div class="sourceCode" id="cb13" data-session="0"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>[x <span class="op">*</span> <span class="fl">0.1</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>)]</span></code></pre></div>
<p>In Python 3.7, this gives <code>[0.0, 0.1, 0.2, 0.30000000000000004, 0.4, 0.5]</code>. Surely, if you give a time-step of <span class="math inline">\(0.1\)</span> to OpenFOAM, it will create a directory named <code>0.3</code> instead. We’ll define the constant <code>epsilon</code> to aid us in identifying the correct state directory given a floating-point time.</p>
<div class="annotated-code">
<p><span><em>«pintfoam-epsilon»=</em></span></p>
<div class="sourceCode" id="pintfoam-epsilon"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-epsilon-1"><a href="#pintfoam-epsilon-1" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> <span class="fl">1e-6</span></span></code></pre></div>
</div>
<p>Our solution depends on the solver chosen and the given time-step:</p>
<div class="annotated-code">
<p><span><em>«pintfoam-solution»=</em></span></p>
<div class="sourceCode" id="pintfoam-solution"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-solution-1"><a href="#pintfoam-solution-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foam(solver: <span class="bu">str</span>, dt: <span class="bu">float</span>, x: Vector, t_0: <span class="bu">float</span>, t_1: <span class="bu">float</span>,</span>
<span id="pintfoam-solution-2"><a href="#pintfoam-solution-2" aria-hidden="true" tabindex="-1"></a>         write_interval: Optional[Union[<span class="bu">int</span>,<span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="pintfoam-solution-3"><a href="#pintfoam-solution-3" aria-hidden="true" tabindex="-1"></a>         job_name: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> Vector:</span>
<span id="pintfoam-solution-4"><a href="#pintfoam-solution-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Call an OpenFOAM code.</span></span>
<span id="pintfoam-solution-5"><a href="#pintfoam-solution-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-solution-6"><a href="#pintfoam-solution-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="pintfoam-solution-7"><a href="#pintfoam-solution-7" aria-hidden="true" tabindex="-1"></a><span class="co">        solver: The name of the solver (e.g. &quot;icoFoam&quot;, &quot;scalarTransportFoam&quot; etc.)</span></span>
<span id="pintfoam-solution-8"><a href="#pintfoam-solution-8" aria-hidden="true" tabindex="-1"></a><span class="co">        dt:     deltaT parameter</span></span>
<span id="pintfoam-solution-9"><a href="#pintfoam-solution-9" aria-hidden="true" tabindex="-1"></a><span class="co">        x:      initial state</span></span>
<span id="pintfoam-solution-10"><a href="#pintfoam-solution-10" aria-hidden="true" tabindex="-1"></a><span class="co">        t_0:    startTime (should match that in initial state)</span></span>
<span id="pintfoam-solution-11"><a href="#pintfoam-solution-11" aria-hidden="true" tabindex="-1"></a><span class="co">        t_1:    endTime</span></span>
<span id="pintfoam-solution-12"><a href="#pintfoam-solution-12" aria-hidden="true" tabindex="-1"></a><span class="co">        write_interval: if not given, this is computed so that only the endTime</span></span>
<span id="pintfoam-solution-13"><a href="#pintfoam-solution-13" aria-hidden="true" tabindex="-1"></a><span class="co">                is written.</span></span>
<span id="pintfoam-solution-14"><a href="#pintfoam-solution-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="pintfoam-solution-15"><a href="#pintfoam-solution-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="pintfoam-solution-16"><a href="#pintfoam-solution-16" aria-hidden="true" tabindex="-1"></a><span class="co">        The `Vector` representing the end state.</span></span>
<span id="pintfoam-solution-17"><a href="#pintfoam-solution-17" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="pintfoam-solution-18"><a href="#pintfoam-solution-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>pintfoam<span class="op">-</span>solution<span class="op">-</span>function<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>The solver clones a new vector, sets the <code>controlDict</code>, runs the solver and then creates a new vector representing the last time slice.</p>
<div class="annotated-code">
<p><span><em>«pintfoam-solution-function»=</em></span></p>
<div class="sourceCode" id="pintfoam-solution-function"><pre class="sourceCode python"><code class="sourceCode python"><span id="pintfoam-solution-function-1"><a href="#pintfoam-solution-function-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">abs</span>(<span class="bu">float</span>(x.time) <span class="op">-</span> t_0) <span class="op">&lt;</span> epsilon, <span class="ss">f&quot;Times should match: </span><span class="sc">{</span>t_0<span class="sc">}</span><span class="ss"> != </span><span class="sc">{x.</span>time<span class="sc">}</span><span class="ss">.&quot;</span></span>
<span id="pintfoam-solution-function-2"><a href="#pintfoam-solution-function-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x.clone(job_name)</span>
<span id="pintfoam-solution-function-3"><a href="#pintfoam-solution-function-3" aria-hidden="true" tabindex="-1"></a>write_interval <span class="op">=</span> write_interval <span class="kw">or</span> (<span class="dv">1</span> <span class="cf">if</span> solver <span class="op">==</span> <span class="st">&quot;scalarTransportFoam&quot;</span> <span class="cf">else</span> dt)</span>
<span id="pintfoam-solution-function-4"><a href="#pintfoam-solution-function-4" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span><span class="bu">set</span><span class="op">-</span>control<span class="op">-</span><span class="bu">dict</span><span class="op">&gt;&gt;</span></span>
<span id="pintfoam-solution-function-5"><a href="#pintfoam-solution-function-5" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>run<span class="op">-</span>solver<span class="op">&gt;&gt;</span></span>
<span id="pintfoam-solution-function-6"><a href="#pintfoam-solution-function-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span><span class="cf">return</span><span class="op">-</span>result<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h3 id="controldict"><code>controlDict</code></h3>
<ul class="task-list">
<li><input type="checkbox" disabled="" checked="" />
check if this is enough to have Adios ‘restart’ from the correct time</li>
</ul>
<div class="annotated-code">
<p><span><em>«set-control-dict»=</em></span></p>
<div class="sourceCode" id="set-control-dict"><pre class="sourceCode python"><code class="sourceCode python"><span id="set-control-dict-1"><a href="#set-control-dict-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):   <span class="co"># this sometimes fails, so we try a few times, maybe disk sync issue?</span></span>
<span id="set-control-dict-2"><a href="#set-control-dict-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="set-control-dict-3"><a href="#set-control-dict-3" aria-hidden="true" tabindex="-1"></a>        controlDict <span class="op">=</span> parameter_file(y, <span class="st">&quot;system/controlDict&quot;</span>)</span>
<span id="set-control-dict-4"><a href="#set-control-dict-4" aria-hidden="true" tabindex="-1"></a>        controlDict.content[<span class="st">&#39;startFrom&#39;</span>] <span class="op">=</span> <span class="st">&quot;latestTime&quot;</span></span>
<span id="set-control-dict-5"><a href="#set-control-dict-5" aria-hidden="true" tabindex="-1"></a>        controlDict.content[<span class="st">&#39;startTime&#39;</span>] <span class="op">=</span> t_0</span>
<span id="set-control-dict-6"><a href="#set-control-dict-6" aria-hidden="true" tabindex="-1"></a>        controlDict.content[<span class="st">&#39;endTime&#39;</span>] <span class="op">=</span> t_1</span>
<span id="set-control-dict-7"><a href="#set-control-dict-7" aria-hidden="true" tabindex="-1"></a>        controlDict.content[<span class="st">&#39;deltaT&#39;</span>] <span class="op">=</span> dt</span>
<span id="set-control-dict-8"><a href="#set-control-dict-8" aria-hidden="true" tabindex="-1"></a>        controlDict.content[<span class="st">&#39;writeInterval&#39;</span>] <span class="op">=</span> write_interval</span>
<span id="set-control-dict-9"><a href="#set-control-dict-9" aria-hidden="true" tabindex="-1"></a>        controlDict.writeFile()</span>
<span id="set-control-dict-10"><a href="#set-control-dict-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="set-control-dict-11"><a href="#set-control-dict-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="set-control-dict-12"><a href="#set-control-dict-12" aria-hidden="true" tabindex="-1"></a>        exception <span class="op">=</span> e</span>
<span id="set-control-dict-13"><a href="#set-control-dict-13" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="set-control-dict-14"><a href="#set-control-dict-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> exception</span></code></pre></div>
</div>
<h3 id="run-solver">Run solver</h3>
<ul class="task-list">
<li><input type="checkbox" disabled="" />
Change <code>Execution.AnalyzedRunner</code> to self-coded <code>subprocess.run</code> type of operation.</li>
</ul>
<div class="annotated-code">
<p><span><em>«run-solver»=</em></span></p>
<div class="sourceCode" id="run-solver"><pre class="sourceCode python"><code class="sourceCode python"><span id="run-solver-1"><a href="#run-solver-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(y.path <span class="op">/</span> <span class="st">&quot;log.stdout&quot;</span>, <span class="st">&quot;w&quot;</span>) <span class="im">as</span> logfile, <span class="op">\</span></span>
<span id="run-solver-2"><a href="#run-solver-2" aria-hidden="true" tabindex="-1"></a>     <span class="bu">open</span>(y.path <span class="op">/</span> <span class="st">&quot;log.stderr&quot;</span>, <span class="st">&quot;w&quot;</span>) <span class="im">as</span> errfile:</span>
<span id="run-solver-3"><a href="#run-solver-3" aria-hidden="true" tabindex="-1"></a>    subprocess.run(solver, cwd<span class="op">=</span>y.path, check<span class="op">=</span><span class="va">True</span>, stdout<span class="op">=</span>logfile, stderr<span class="op">=</span>errfile)</span></code></pre></div>
</div>
<h3 id="return-result">Return result</h3>
<div class="annotated-code">
<p><span><em>«return-result»=</em></span></p>
<div class="sourceCode" id="return-result"><pre class="sourceCode python"><code class="sourceCode python"><span id="return-result-1"><a href="#return-result-1" aria-hidden="true" tabindex="-1"></a>t1_str <span class="op">=</span> get_times(y.path)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="return-result-2"><a href="#return-result-2" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> Vector(y.base, y.case, t1_str)</span></code></pre></div>
</div>
<h1 id="running-parareal">Running Parareal</h1>
<div class="annotated-code">
<p><span><em>«run.py»=</em></span></p>
<div class="sourceCode" id="cb14" data-file="run.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> noodles</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> noodles.draw_workflow <span class="im">import</span> draw_workflow</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> noodles.run.threading.vanilla <span class="im">import</span> run_parallel</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> noodles.run.process <span class="im">import</span> run_process</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> noodles.run.single.vanilla <span class="im">import</span> run_single</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> noodles.display.simple_nc <span class="im">import</span> Display</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> noodles <span class="im">import</span> serial</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> paranoodles <span class="im">import</span> tabulate, parareal</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pintFoam.vector <span class="im">import</span> BaseCase</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pintFoam.run <span class="im">import</span> (coarse, fine, registry)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> paint(node, name):</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> name <span class="op">==</span> <span class="st">&quot;coarse&quot;</span>:</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        node.attr[<span class="st">&quot;fillcolor&quot;</span>] <span class="op">=</span> <span class="st">&quot;#cccccc&quot;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> name <span class="op">==</span> <span class="st">&quot;fine&quot;</span>:</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        node.attr[<span class="st">&quot;fillcolor&quot;</span>] <span class="op">=</span> <span class="st">&quot;#88ff88&quot;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        node.attr[<span class="st">&quot;fillcolor&quot;</span>] <span class="op">=</span> <span class="st">&quot;#ffffff&quot;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.linspace(<span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="dv">6</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    base_case <span class="op">=</span> BaseCase(Path(<span class="st">&quot;data/c1&quot;</span>).resolve(), <span class="st">&quot;baseCase&quot;</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> noodles.gather(<span class="op">*</span>tabulate(coarse, base_case.new_vector(), t))</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> noodles.gather(<span class="op">*</span>parareal(fine, coarse)(y, t))</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># draw_workflow(&quot;wf.svg&quot;, noodles.get_workflow(s), paint)</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> run_process(s, n_processes<span class="op">=</span><span class="dv">4</span>, registry<span class="op">=</span>registry, verbose<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># result = run_single(s)</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(result)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co"># base_case.clean()</span></span></code></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox" disabled="" />
update Noodles registry to work with Adios files.</li>
</ul>
<div class="annotated-code">
<p><span><em>«pintFoam/run.py»=</em></span></p>
<div class="sourceCode" id="cb15" data-file="pintFoam/run.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> noodles   <span class="co"># type: ignore</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> noodles <span class="im">import</span> serial</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .solution <span class="im">import</span> foam</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="at">@noodles.schedule</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fine(x, t_0, t_1):</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> foam(<span class="st">&quot;icoFoam&quot;</span>, <span class="fl">0.05</span>, x, t_0, t_1)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="at">@noodles.schedule</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> coarse(x, t_0, t_1):</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> foam(<span class="st">&quot;icoFoam&quot;</span>, <span class="fl">0.2</span>, x, t_0, t_1)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> registry():</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> serial.base() <span class="op">+</span> serial.numpy()</span></code></pre></div>
</div>
<h1 id="the-user-script">The User script</h1>
<p>As the final bit, the user should write a (minimal) script for running the simulation. Here we write an example script in the <code>data</code> folder. There should be no reusable parts in this script, or they should go into either the <code>paranoodles</code> or <code>pintFoam</code> module.</p>
<p>Time for a bit of wishful programming</p>
<div class="annotated-code">
<p><span><em>«data/run.py»=</em></span></p>
<div class="sourceCode" id="cb16" data-file="data/run.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> noodles <span class="im">import</span> (gather)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> paranoodles <span class="im">import</span> (schedule, run, parareal, tabulate)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pintFoam <span class="im">import</span> (BaseCase, foam, block_mesh, serial)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>case <span class="op">=</span> BaseCase(Path(<span class="st">&quot;c1&quot;</span>), <span class="st">&quot;baseCase&quot;</span>, fields<span class="op">=</span>[<span class="st">&quot;p&quot;</span>, <span class="st">&quot;U&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;phi_0&quot;</span>, <span class="st">&quot;pMean&quot;</span>, <span class="st">&quot;pPrime2Mean&quot;</span>, <span class="st">&quot;U_0&quot;</span>, <span class="st">&quot;UMean&quot;</span>, <span class="st">&quot;UPrime2Mean&quot;</span>])</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>block_mesh(case)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>times <span class="op">=</span> np.linspace(<span class="fl">0.0</span>, <span class="fl">350.0</span>, <span class="dv">11</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="at">@schedule</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fine(n, x, t_0, t_1):</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> foam(<span class="st">&quot;icoFoam&quot;</span>, <span class="fl">0.05</span>, x, t_0, t_1,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                job_name<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{n}</span><span class="ss">-</span><span class="sc">{</span><span class="bu">int</span>(t_0)<span class="sc">:03}</span><span class="ss">-</span><span class="sc">{</span><span class="bu">int</span>(t_1)<span class="sc">:03}</span><span class="ss">-fine&quot;</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="at">@schedule</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> coarse(n, x, t_0, t_1):</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> foam(<span class="st">&quot;icoFoam&quot;</span>, <span class="fl">1.0</span>, x, t_0, t_1,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>                job_name<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{n}</span><span class="ss">-</span><span class="sc">{</span><span class="bu">int</span>(t_0)<span class="sc">:03}</span><span class="ss">-</span><span class="sc">{</span><span class="bu">int</span>(t_1)<span class="sc">:03}</span><span class="ss">-coarse&quot;</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="co"># init = foam(&quot;icoFoam&quot;, 0.0001, case.new_vector(), 0.0, 0.0)</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>init <span class="op">=</span> case.new_vector(<span class="st">&quot;init&quot;</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> gather(<span class="op">*</span>tabulate(partial(coarse, <span class="dv">0</span>), init, times))</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>):</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> gather(<span class="op">*</span>parareal(partial(coarse, n), partial(fine, n))(y, times))</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>run(y, n_threads<span class="op">=</span><span class="dv">4</span>, registry<span class="op">=</span>serial, db_file<span class="op">=</span><span class="st">&quot;noodles.db&quot;</span>)</span></code></pre></div>
</div>
<h1 id="appendix-a-utils">Appendix A: Utils</h1>
<div class="annotated-code">
<p><span><em>«pintFoam/utils.py»=</em></span></p>
<div class="sourceCode" id="cb17" data-file="pintFoam/utils.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>push<span class="op">-</span><span class="bu">dir</span><span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h2 id="cleaning-up">Cleaning up</h2>
<div class="annotated-code">
<p><span><em>«pintFoam/clean.py»=</em></span></p>
<div class="sourceCode" id="cb18" data-file="pintFoam/clean.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argh  <span class="co"># type:ignore</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .vector <span class="im">import</span> BaseCase</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="at">@argh.arg</span>(<span class="st">&quot;target&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;target path to clean&quot;</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="at">@argh.arg</span>(<span class="st">&quot;--base_case&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;name of the base-case&quot;</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main(target: Path, base_case: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;baseCase&quot;</span>):</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    BaseCase(Path(target), base_case).clean()</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    argh.dispatch_command(main)</span></code></pre></div>
</div>
<h2 id="pushd"><code>pushd</code></h2>
<p>I haven’t been able (with simple attempts) to run a case outside the definition directory. Similar to the <code>pushd</code> bash command, I define a little utility in Python:</p>
<div class="annotated-code">
<p><span><em>«push-dir»=</em></span></p>
<div class="sourceCode" id="push-dir"><pre class="sourceCode python"><code class="sourceCode python"><span id="push-dir-1"><a href="#push-dir-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="push-dir-2"><a href="#push-dir-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="push-dir-3"><a href="#push-dir-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> contextlib <span class="im">import</span> contextmanager</span>
<span id="push-dir-4"><a href="#push-dir-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Union</span>
<span id="push-dir-5"><a href="#push-dir-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> functools</span>
<span id="push-dir-6"><a href="#push-dir-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="push-dir-7"><a href="#push-dir-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="push-dir-8"><a href="#push-dir-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decorator(f):</span>
<span id="push-dir-9"><a href="#push-dir-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Creates a parametric decorator from a function. The resulting decorator</span></span>
<span id="push-dir-10"><a href="#push-dir-10" aria-hidden="true" tabindex="-1"></a><span class="co">    will optionally take keyword arguments.&quot;&quot;&quot;</span></span>
<span id="push-dir-11"><a href="#push-dir-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@functools.wraps</span>(f)</span>
<span id="push-dir-12"><a href="#push-dir-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> decorated_function(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="push-dir-13"><a href="#push-dir-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> args <span class="kw">and</span> <span class="bu">len</span>(args) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="push-dir-14"><a href="#push-dir-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> f(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="push-dir-15"><a href="#push-dir-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="push-dir-16"><a href="#push-dir-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> args:</span>
<span id="push-dir-17"><a href="#push-dir-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">TypeError</span>(</span>
<span id="push-dir-18"><a href="#push-dir-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;This decorator only accepts extra keyword arguments.&quot;</span>)</span>
<span id="push-dir-19"><a href="#push-dir-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="push-dir-20"><a href="#push-dir-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">lambda</span> g: f(g, <span class="op">**</span>kwargs)</span>
<span id="push-dir-21"><a href="#push-dir-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="push-dir-22"><a href="#push-dir-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> decorated_function</span>
<span id="push-dir-23"><a href="#push-dir-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="push-dir-24"><a href="#push-dir-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="push-dir-25"><a href="#push-dir-25" aria-hidden="true" tabindex="-1"></a><span class="at">@contextmanager</span></span>
<span id="push-dir-26"><a href="#push-dir-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pushd(path: Union[<span class="bu">str</span>, Path]):</span>
<span id="push-dir-27"><a href="#push-dir-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Context manager to change directory to given path,</span></span>
<span id="push-dir-28"><a href="#push-dir-28" aria-hidden="true" tabindex="-1"></a><span class="co">    and get back to current dir at exit.&quot;&quot;&quot;</span></span>
<span id="push-dir-29"><a href="#push-dir-29" aria-hidden="true" tabindex="-1"></a>    prev <span class="op">=</span> Path.cwd()</span>
<span id="push-dir-30"><a href="#push-dir-30" aria-hidden="true" tabindex="-1"></a>    os.chdir(path)</span>
<span id="push-dir-31"><a href="#push-dir-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="push-dir-32"><a href="#push-dir-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="push-dir-33"><a href="#push-dir-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span></span>
<span id="push-dir-34"><a href="#push-dir-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="push-dir-35"><a href="#push-dir-35" aria-hidden="true" tabindex="-1"></a>        os.chdir(prev)</span></code></pre></div>
</div>
<h1 id="input-and-output">Input and Output</h1>
<p>There are utilities that read OpenFOAM files, but they are all broken.</p>
</div></main>



<!-- Bootstrap 4.5.0 -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

<!-- Mathjax -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>
